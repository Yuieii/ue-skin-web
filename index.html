<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <style>
            .flex-container {
                display: flex;
            }

            .flex-container:not(#container) {
                justify-content: center;
            }

            .repo-link {
                margin: 0 50px;
                margin-bottom: 20px;
                color: #000;
                font-size: 0.9rem;
                text-decoration: none;
                border-radius: 9999px;
                padding: 0.77em;
                opacity: 0.5;
            }

            .repo-link > * {
                vertical-align: middle;
            }

            .repo-link:hover {
                background: #eee;
            }

            .flex-container#container {
                flex-wrap: wrap;
                justify-content: center;
            }

            .skin-item {
                text-align: center;
                position: relative;
                margin: 10px 0;
                display: inline-block;
                margin: 15px;
                background: #fff;
                border: 1px solid #eee;
                border-radius: 8px;
                box-shadow: 0px 0px 5px #ccc;
                overflow: hidden;
            }

            .avatar {
                padding: 10px;
                width: 64px;
                position: absolute;
                top: 15px;
                left: 15px;
            }

            .skin-3d {
                /* filter: drop-shadow(0 0 0.75rem rgba(0, 0, 0, .5)); */
                opacity: 0;
            }

            .skin-3d.skin-loaded {
                transition: opacity 1s;
                opacity: 1;   
            }

            @media screen and (max-width: 560px) {
                .skin-3d {
                    max-width: calc(100vw - 70px);
                    min-width: 250px;
                }
            }

            .fullscreen {
                overflow: hidden;
            }
            
            .fullscreen #container {
                width: 100vw;
                height: 100vh;
            }

            .fullscreen #container .skin-item {
                position: initial;
                margin: initial;
                display: initial;
                margin: initial;
                background: transparent;
                border: initial;
                border-radius: initial;
                box-shadow: initial;
                overflow: initial;
                width: 100%;
                max-width: fit-content;
            }

            .fullscreen #container .skin-item .avatar {
                display: none;
            }

        </style>
    </head>
    <body class="">
        <div id="container" class="flex-container"></div>
        <!-- <div class="flex-container">
            <a class="repo-link" href="#" target="_blank">
                <img src="https://static-00.iconduck.com/assets.00/pleading-face-emoji-2048x2048-z5m6xd68.png" width="24" />
            </a>
        </div> -->
    </body>
    <script type="module">
        import { AvatarRenderer } from "./build/avatarRenderer.js";
        import { SkinRendererFactory } from "./build/skinRenderer/factory.js";
        import { PoseType } from "./build/skinRenderer/base.js";
        import { memoize } from "./build/common.js";
        window.memoize = memoize;

        const params = new URLSearchParams(location.search);
        if (params.has("full")) {
            document.body.classList.add("fullscreen");
        }

        (async () => {
            const skins = [
                {
                    path: "yuieii.png",
                    slim: true
                }
            ];

            const renderers = [];
            const container = document.getElementById("container");
            for (let i = 0; i < skins.length; i++) {
                const div = document.createElement("div");
                div.classList.add("skin-item");
                const skin = skins[i];

                await (async () => {
                    const renderer = await SkinRendererFactory.createPreferred(skin.path, !!skin.slim);
                    renderer.noAnim = false;

                    renderer.noGrass = true;
                    renderer.noEeveeEars = true;
                    renderer.noCatEars = true;
                    renderer.noCatTail = true;
                    
                    const canvas = await renderer.createCanvas();

                    const mult = 2 * window.devicePixelRatio; // Math.sqrt(2);
                    canvas.width = 420 * mult;
                    canvas.height = 720 * mult;


                    if (document.body.classList.contains("fullscreen")) {
                        canvas.style.height = "100vh";
                    } else {
                        canvas.style.width = canvas.width / mult;
                    }
                    
                    canvas.classList.add("skin-3d");
                    div.appendChild(canvas);
                    renderers.push(renderer);
                    container.appendChild(div);

                    // Use VTube Studio if we are on localhost and we specifically want that
                    if (
                        location.origin.toLowerCase().match(/^(?:127\.0\.0\.1|localhost)$/g) ||
                        params.has("vts")
                    )
                    {
                        renderer.poseType = PoseType.VTubeStudio;
                    } else {
                        // Available options: (enum PoseType @ base.ts:291)
                        // - Walk
                        // - LookAtMouseCursor
                        // - BackLookAtMouseCursor
                        // - VTubeStudio
                        renderer.poseType = PoseType.Walk;
                    }
                    
                    renderer.initAnimation();
                })();

                await (async () => {
                    const renderer = new AvatarRenderer(skin.path);
                    renderer.noGrass = false;
                    renderer.resolution = 512; 
                    const canvas = await renderer.createAvatarCanvas();
                    canvas.dataset.skinUrl = skin.path;
                    canvas.classList.add("avatar");
                    div.appendChild(canvas);
                })();
            }

            function render() {
                requestAnimationFrame(() => render());

                const removal = [];
                renderers.forEach(r => {
                    try {
                        // r.poseType = PoseType.Walk;
                        // r.poseType = PoseType.LookAtMouseCursor;
                        r.update();
                    } catch(ex) {
                        console.error(ex);
                        removal.push(r);
                    }
                });

                removal.forEach(r => renderers.splice(renderers.indexOf(r), 1));
            }
            render();

            renderers.forEach(r => {
                r.canvas.classList.add("skin-loaded");
            });
        })();
    </script>
</html>